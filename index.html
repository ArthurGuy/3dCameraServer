<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <title>3D Scanner</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <style>
    .thumbnail {
        width: 100%;
    }
    </style>

</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12">
                <h1>3D Scanner Camera Coordinator</h1>
                <input type="button" id="takePhoto" value="Take Photo" class="btn btn-success"><br><br>
            </div>
        </div>
        <div class="row" id="photoGrid">
            <div class="col-xs-3">
                <img src="/img/placeholder.png" id="newPhoto" class="thumbnail">
            </div>
            <div class="col-xs-3">
                <img src="/img/placeholder.png" id="newPhoto" class="thumbnail">
            </div>
            <div class="col-xs-3">
                <img src="/img/placeholder.png" id="newPhoto" class="thumbnail">
            </div>
            <div class="col-xs-3">
                <img src="/img/placeholder.png" id="newPhoto" class="thumbnail">
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                Connected Cameras: <span id="cameraCount">0</span>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>IP</th>
                            <th>Waiting for photo</th>
                            <th>Last Checkin</th>
                            <th>Error taking photo</th>
                        </tr>
                    </thead>
                    <tbody id="cameraList">

                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script src="/js/socket.io-1.4.5.js"></script>
    <script src="/js/jquery-3.1.1.slim.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <script>
        var clientId = guid();

        var socket = io('http://' + location.hostname + ':3000');

        var cameras = [];

        $(document).ready(function() {

            $('#takePhoto').click(function (event) {
                takeId = guid();
                event.preventDefault();
                socket.emit('take-photo', {takeId: takeId, time: Date.now()});

                $('#photoGrid').html('');
            });

            socket.on('new-photo', function(data){
                //console.log("new photo", data);
                $('#photoGrid').append('<div class="col-xs-3"><img src="data:image/png;base64,' + data.data + '" class="thumbnail"><br>' + data.cameraName + '</div>');

                $('#photoGrid').append('<div class="col-xs-3"><img src="' + data.imagePath + '" class="thumbnail"><br>' + data.cameraName + '</div>');
            });

            socket.on('photo-error', function(response){
                console.log("photo error", response);
            });

            // A camera had come online or been taken offline
            socket.on('camera-update', function(response){
                console.log("camera update", response);
                cameras = response;

                displayCameraList();
            });
        });

        function displayCameraList() {
            $('#cameraList').html('');
            for (let i = 0; i < cameras.length; i++) {
                if (cameras[i].name !== null) {
                    var photoError = '';
                    if (cameras[i].photoError) {
                        photoError = 'yes';
                    }
                    let waitingOnPhoto = 'no';
                    if (cameras[i].waitingOnPhoto) {
                        waitingOnPhoto = 'yes';
                    }
                    var timeSinceLastUpdate = Math.round((new Date() - cameras[i].lastCheckin) / 100) / 10;
                    $('#cameraList').append('<tr><td>'+cameras[i].name+'</td><td>'+cameras[i].ipAddress+'</td><td>'+waitingOnPhoto + '</td><td>' + timeSinceLastUpdate+'s</td><td>'+photoError+'</td></tr>');
                }

            }
            $('#cameraCount').text(cameras.length - 1);
        }

        function guid() {
          function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
              .toString(16)
              .substring(1);
          }
          return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
            s4() + '-' + s4() + s4() + s4();
        }
    </script>

</body>
</html>
